<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Script example · Elkarbackup Docs</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Let&#x27;s imagine that different users have different copies of the same file on the network, each in their folder. When it comes to office documents \(generally not very large\) is not usually too much trouble, but with other types of files \(videos, software updates, etc.\) the space that may be consuming in the network is usually large, being duplicate information."/><meta name="docsearch:version" content="1.3"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Script example · Elkarbackup Docs"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.elkarbackup.org/index.html"/><meta property="og:description" content="Let&#x27;s imagine that different users have different copies of the same file on the network, each in their folder. When it comes to office documents \(generally not very large\) is not usually too much trouble, but with other types of files \(videos, software updates, etc.\) the space that may be consuming in the network is usually large, being duplicate information."/><meta property="og:image" content="https://docs.elkarbackup.org/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://docs.elkarbackup.org/img/docusaurus.png"/><link rel="shortcut icon" href="/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-3914088-13', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script type="text/javascript" src="/js/elkarbackup.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><h2 class="headerTitle">Elkarbackup Docs</h2></a><a href="/versions.html"><h3>1.3</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/1.3/installation.html" target="_self">Installation</a></li><li class="siteNavGroupActive"><a href="/docs/1.3/introduction.html" target="_self">Documentation</a></li><li class="siteNavGroupActive"><a href="/docs/1.3/troubleshooting.html" target="_self">Troubleshooting</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Scripts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/introduction.html">What is it?</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/why-elkarbackup.html">Why Elkarbackup?</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Installation</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/installation.html">Installation</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/getting-started.html">Getting started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Clients and jobs</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/clients-jobs.html">Clients and jobs</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/hosts-linux.html">Linux hosts</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/hosts-windows.html">Windows hosts</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/advanced-connection-options.html">Advanced connection options</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/hosts-solving-problems.html">Solving problems</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Backup status</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/backup-status.html">Backup status</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Backup policies</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/policies-new.html">Adding policies</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/policies-schedule.html">Schedule</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/policies-outdated-data.html">Outdated data</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/policies-different.html">Using different policies</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/sort-jobs.html">Sort Jobs</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Scripts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/script-intro.html">Scripts</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/script-new.html">Creating a new script</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/1.3/script-example.html">Script example</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Settings</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/manage-parameters.html">Manage parameters</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/storages.html">Backup storages</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/storage-nfs.html">NFS storage</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/storage-tahoe.html">Configure Tahoe-LAFS storage</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/backup-mirror.html">Backup mirror</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">A review of concepts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/concepts-rsnapshot.html">Rsnapshot</a></li><li class="navListItem"><a class="navItem" href="/docs/1.3/concepts-tahoe.html">Tahoe</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Troubleshooting</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/1.3/troubleshooting.html">Troubleshooting</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/elkarbackup/elkarbackup-docs/edit/master/docs/script-example.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Script example</h1></header><article><div><span><p>Let's imagine that different users have different copies of the same file on the network, each in their folder. When it comes to office documents (generally not very large) is not usually too much trouble, but with other types of files (videos, software updates, etc.) the space that may be consuming in the network is usually large, being duplicate information.</p>
<p>We know that once you have made the copy of these files, they will not change on the Elkarbackup disk, so we have the possibility to keep a single copy and linking the other occurrences of the same file using hardlinks.</p>
<p>In this example, we copy and paste with another name a file that we have in the folder <em><strong>/media/Backups</strong></em> of the Debian Client. Although it is the same file we have it twice on the disk so it occupies the double.</p>
<pre><code class="hljs"><span class="hljs-symbol">root@</span>DebianClient:~\# cd /media/Backups/Software/
<span class="hljs-symbol">root@</span>DebianClient:/media/Backups/Software\# cp vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32.exe vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32-kopia.exe
<span class="hljs-symbol">root@</span>DebianClient:/media/Backups/Software\# ls -lah
total <span class="hljs-number">209</span>M

drwxr-xr-x <span class="hljs-number">2</span> root root <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K jun <span class="hljs-number">12</span> <span class="hljs-number">12</span>:<span class="hljs-number">44</span> .
drwxr-xr-x <span class="hljs-number">4</span> root root <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K jun  <span class="hljs-number">7</span> <span class="hljs-number">11</span>:<span class="hljs-number">24</span> ..
-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">1</span>,<span class="hljs-number">1</span>M nov <span class="hljs-number">18</span>  <span class="hljs-number">2010</span> <span class="hljs-number">7</span>z920.exe
-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">164</span>M may  <span class="hljs-number">3</span> <span class="hljs-number">18</span>:<span class="hljs-number">16</span> LibreOffice\_4<span class="hljs-number">.0</span><span class="hljs-number">.3</span>\_Linux\_x86\_deb.tar.gz
-rw-r--r-- <span class="hljs-number">1</span> root root  <span class="hljs-number">22</span>M abr <span class="hljs-number">15</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32.exe
-rw-r--r-- <span class="hljs-number">1</span> root root  <span class="hljs-number">22</span>M jun <span class="hljs-number">12</span> <span class="hljs-number">12</span>:<span class="hljs-number">44</span> vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32-copy.exe
</code></pre>
<p>Now we access the task in charge of making the copy of this data and press the button <em><strong>Run now</strong></em>. At the end of the task we can see that in the folder of the ElkarBackup server there are the two files</p>
<pre><code class="hljs">#cd /var/spool/elkarbackup/backups/<span class="hljs-number">0001</span>/<span class="hljs-number">0001</span>/Hourly<span class="hljs-number">.0</span>/media/Backups/Software/
#ls -lah
total <span class="hljs-number">209</span>M
drwxrwxr-x <span class="hljs-number">2</span> elkarbackup elkarbackup <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K jun <span class="hljs-number">12</span> <span class="hljs-number">12</span>:<span class="hljs-number">44</span> .
drwxrwxr-x <span class="hljs-number">4</span> elkarbackup elkarbackup <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K jun  <span class="hljs-number">7</span> <span class="hljs-number">11</span>:<span class="hljs-number">24</span> ..
-rw-rw-r-- <span class="hljs-number">3</span> elkarbackup elkarbackup <span class="hljs-number">1</span>,<span class="hljs-number">1</span>M nov <span class="hljs-number">18</span>  <span class="hljs-number">2010</span> <span class="hljs-number">7</span>z920.exe
-rw-rw-r-- <span class="hljs-number">3</span> elkarbackup elkarbackup <span class="hljs-number">164</span>M may  <span class="hljs-number">3</span> <span class="hljs-number">18</span>:<span class="hljs-number">16</span> LibreOffice\_4<span class="hljs-number">.0</span><span class="hljs-number">.3</span>\_Linux\_x86\_deb.tar.gz
-rw-rw-r-- <span class="hljs-number">3</span> elkarbackup elkarbackup  <span class="hljs-number">22</span>M abr <span class="hljs-number">15</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32.exe
-rw-rw-r-- <span class="hljs-number">2</span> elkarbackup elkarbackup  <span class="hljs-number">22</span>M jun <span class="hljs-number">12</span> <span class="hljs-number">12</span>:<span class="hljs-number">44</span> vlc<span class="hljs-number">-2.0</span><span class="hljs-number">.6</span>-win32-copy.exe
</code></pre>
<p>And as we can see they are not bound by hardlinks, since they do not have the same inode</p>
<blockquote>
<p># ls -lahi</p>
<p>total 209M</p>
<p>40831 drwxrwxr-x 2 elkarbackup elkarbackup 4,0K jun 12 12:44 .</p>
<p>40828 drwxrwxr-x 4 elkarbackup elkarbackup 4,0K jun  7 11:24 ..</p>
<p>29332 -rw-rw-r-- 3 elkarbackup elkarbackup 1,1M nov 18  2010 7z920.exe</p>
<p>29333 -rw-rw-r-- 3 elkarbackup elkarbackup 164M may  3 18:16 LibreOffice_4.0.3_Linux_x86_deb.tar.gz</p>
<p>29334 -rw-rw-r-- 3 elkarbackup elkarbackup  22M abr 15 19:11 vlc-2.0.6-win32.exe</p>
<p>74101 -rw-rw-r-- 2 elkarbackup elkarbackup  22M jun 12 12:44 vlc-2.0.6-win32-copy.exe</p>
</blockquote>
<p>Here's how we can use a postscript script to solve this problem. This script looks for those files that have the same <a href="https://en.wikipedia.org/wiki/Hash_function">Hash</a> and links them through hardlinks</p>
<blockquote>
<p>#!/bin/bash</p>
<p># Compare by size to discard those that do not repeat</p>
<p>cd $ELKARBACKUP_PATH</p>
<p>lastHash=''</p>
<p>lastFile=''</p>
<p>find . -mount -type f -printf '%15s %p\0'|sort -nrz|uniq -zDw15|tr &quot;\0&quot; &quot;\n&quot;|cut -b17- |tr &quot;\n&quot; &quot;\0&quot;|xargs -0 sha256sum|sort|uniq -Dw40|while read currentHash file</p>
<p>do</p>
<pre><code class="hljs">    if [ &quot;x$lastHash&quot; = &quot;x$currentHash&quot; ]

    then
            rm &quot;$file&quot;
            ln &quot;$lastFile&quot; &quot;$file&quot;
    fi

    lastHash=$currentHash

    lastFile=&quot;$file&quot;
</code></pre>
<p>done</p>
</blockquote>
<p>We upload the script:</p>
<ul>
<li>Name: Compressing the repository</li>
<li>We enable it so that it can be executed as PostScritp of tasks</li>
</ul>
<p>Now we edit the Debian Client task, select this script in the PostScript section, and launch the task's execution.</p>
<blockquote>
<p># ls -lahi</p>
<p>total 209M</p>
<p>40838 drwxrwxr-x 2 elkarbackup elkarbackup 4,0K jun 12 15:22 .</p>
<p>40835 drwxrwxr-x 4 elkarbackup elkarbackup 4,0K jun  7 11:24 ..</p>
<p>29332 -rw-rw-r-- 4 elkarbackup elkarbackup 1,1M nov 18  2010 7z920.exe</p>
<p>29333 -rw-rw-r-- 4 elkarbackup elkarbackup 164M may  3 18:16 LibreOffice_4.0.3_Linux_x86_deb.tar.gz</p>
<p><strong>29334</strong> -rw-rw-r-- 8 elkarbackup elkarbackup  22M abr 15 19:11 vlc-2.0.6-win32.exe</p>
<p><strong>29334</strong> -rw-rw-r-- 8 elkarbackup elkarbackup  22M abr 15 19:11 vlc-2.0.6-win32-copy.exe</p>
</blockquote>
<p>If we now look at the inode numbers that appear in the first column, we can see that the copies appear with the same inode, so they are pointing to the same location on disk and without duplicating the space used.</p>
<h2><a class="anchor" aria-hidden="true" id="cloud-synchronization"></a><a href="#cloud-synchronization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cloud synchronization</h2>
<p>Nowadays it seems inevitable that when developing a backup tool we pause to think about whether to incorporate specific functionalities to synchronize our data with the services in the cloud.</p>
<p>In this application no specific section has been developed for this function because we have seen that with the services that offer this type of solutions we do not need to develop anything extra.</p>
<p>If you look at the well known Dropbox, we see that it has a type of installation <a href="https://www.dropbox.com/install-linux">to be executed as a daemon</a> on a Linux machine.</p>
<p>If we have installed Dropbox on our Elkarbackup server, we can develop a PostScript so that  links the files we want to sync with the cloud through hardlinks linking to a Dropbox folder. With this we would already have these files copied in the cloud automatically.</p>
<p>At this point we could discuss about the convenience of having our data in the cloud, issues such as data privacy, etc, but hey, we will leave it for another occasion.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/1.3/script-new.html"><span class="arrow-prev">← </span><span>Creating a new script</span></a><a class="docs-next button" href="/docs/1.3/manage-parameters.html"><span>Manage parameters</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#cloud-synchronization">Cloud synchronization</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Documentation</h5><a href="/docs/en/getting-started.html">Getting Started</a><a href="/docs/en/installation.html">Installation</a><a href="/docs/en/troubleshooting.html">Troubleshooting</a></div><div><h5>Community</h5><a href="http://stackoverflow.com/questions/tagged/elkarbackup" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://crowdin.com/project/elkarbackup">Translate</a><a href="https://twitter.com/elkarbackup/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="https://www.elkarbackup.org">Website</a><a href="https://github.com/elkarbackup/elkarbackup">GitHub</a><a class="github-button" href="https://github.com/elkarbackup/elkarbackup" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2021 ElkarBackup</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '7f2bf4bca0a9b06c05b54d12e953811d',
                indexName: 'elkarbackup',
                inputSelector: '#search_input_react'
              });
            </script></body></html>